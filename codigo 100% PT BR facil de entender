#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <windows.h>
#include <time.h>
#define largura_tijolo 10
#define largura 54
#define altura 10

int matriz[23][80] = {0}, i, j, k, direcao, bola_x, bola_y, posicao_barra, pontuacao;
char tecla;

void inicializar()
{
    //******************IMPORTANTE********************
    // Definindo a direção inicial da bola
    direcao = 45;
    //***********************************************

    pontuacao = 0;

    // Geração das paredes nas bordas
    for(i = 1; i < 23; i++) matriz[i][1] = 6;
    for(i = 1; i < 23; i++) matriz[i][79] = 6;
    for(j = 1; j < 80; j++) matriz[1][j] = 7;
    for(j = 1; j < 80; j++) matriz[22][j] = 7;

    // Geração aleatória dos tijolos
    srand(time(NULL));
    for(i = 2; i <= altura; i++)
    {
        for(j = 10; j <= largura; j++)
        {
           if(j % largura_tijolo == 0)
           {
               matriz[i][j] = rand() % 3 + 1;
               for(k = j + 1; k < j + largura_tijolo; k++) matriz[i][k] = matriz[i][j];
           }
        }
    }

    // Bola inicia na posição (18,19)
    matriz[18][19] = 4;
    bola_x = 18;
    bola_y = 19;

    // Barra com comprimento 10
    for(j = 25; j < 35; j++) matriz[19][j] = 5;
    posicao_barra = 25;
}

void jogabilidade()
{
    while(TRUE)
    {
        COORD coord;
        coord.X = 0;
        coord.Y = 0;
        SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), coord);

        SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 160);
        printf("       Pontuação: %d\n", pontuacao);

        for(i = 1; i < 23; i++)
        {
            for(j = 1; j < 80; j++)
            {
                if(matriz[i][j] == 0)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 120);
                else if(matriz[i][j] == 1)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 135);
                else if(matriz[i][j] == 2)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 79);
                else if(matriz[i][j] == 3)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 103);
                else if(matriz[i][j] == 4)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 30);
                else if(matriz[i][j] == 5)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 170);
                else if(matriz[i][j] == 6)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 250);
                else if(matriz[i][j] == 7)  SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 250);

                if(matriz[i][j] != 4) printf(" ");
                else printf("0");
            }
            printf("\n");
        }

        for(i = 1; i <= 3; i++)
        {
            Sleep(1);
            if (kbhit())
            {
                tecla = getch();
                if(tecla == ' ')
                {
                    for(;;)
                    {
                        Sleep(100);
                        if (kbhit())
                        {
                            tecla = getch();
                            if(tecla == ' ')
                            {
                                goto continuar;
                            }
                        }
                    }
                }
                else
                {
                    if(tecla == 'a')
                    {
                        for(k = posicao_barra; k < posicao_barra + 10; k++) matriz[19][k] = 0;
                        posicao_barra -= 2;
                        for(k = posicao_barra; k < posicao_barra + 10; k++) matriz[19][k] = 5;
                    }
                    if(tecla == 'd')
                    {
                        for(k = posicao_barra; k < posicao_barra + 10; k++) matriz[19][k] = 0;
                        posicao_barra += 2;
                        for(k = posicao_barra; k < posicao_barra + 10; k++) matriz[19][k] = 5;
                    }
                }
            }
        }

        continuar:;

        if(direcao == 0)
        {
            if(matriz[bola_x][bola_y + 1] == 0)
            {
                matriz[bola_x][bola_y + 1] = 4;
                matriz[bola_x][bola_y] = 0;
                bola_y++;
            }
            else
            {
                direcao = 180;

                if(matriz[bola_x][bola_y + 1] == 2)
                {
                    pontuacao++;
                    for(k = (bola_y + 1) / largura_tijolo * 10; k < (bola_y + 1) / largura_tijolo * 10 + largura_tijolo; k++)
                        matriz[bola_x][k] = 0;
                }
                else if(matriz[bola_x][bola_y + 1] == 3)
                {
                    pontuacao++;
                    for(k = (bola_y + 1) / largura_tijolo * 10; k < (bola_y + 1) / largura_tijolo * 10 + largura_tijolo; k++)
                        matriz[bola_x][k] = 2;
                }
            }
        }

        // Continuação com as outras direções
        // ...
    }
}

void gameover()
{
    system("CLS");
    printf("FIM DO JOGO!\nPRESSIONE QUALQUER TECLA PARA FECHAR O JOGO!");
    while (TRUE)
    {
        if(kbhit())
        {
            return;
        }
        Sleep(1);
    }
}

int main()
{
    inicializar();
    jogabilidade();
    return 0;
}
